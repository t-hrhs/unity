using UnityEngine;
using System.Collections;

public class GameController : MonoBehaviour {
	private const int ball_num = 4; //the number of default ball is FOUR
	public GameObject ball_prefab; //basic of ball;
	public GameObject[] balls = new GameObject[ball_num];
	public static int turn =  3;
	public static int score = 0;
	public static bool user_touchable = true;
	public Rect position = new Rect (240, 275, 200, 15);
    public Vector3 ballPosition = Vector3.zero;

    // User Interface for shooting ball
    public GameObject angularController;
    public GameObject velocityController;
    public GameObject shootingButton;

	//make a ball
	void make_a_ball(int index) {
		balls[index] = Instantiate (
			ball_prefab,
			new Vector3((float)1.0f,(float)0.5f,(float)(5.0f-2.0f*index)),
			Quaternion.identity
		) as GameObject;
		Ball ballscript = balls[index].GetComponent<Ball>();
		ballscript.color_id = index;
		ballscript.draw_ball(index);
	}

	// Use this for initialization
	void Start () {
		int i = 0;
		for (i=0;i<ball_num;i++) {
			make_a_ball(i);
		}
        Instantiate(angularController);
	}
	
	// Update is called once per frame
	void Update () {
		//update the score per function called
        this.ballPosition = GameObject.Find("My_Ball").transform.position;
        AngularController angularControllerScript = angularController.GetComponent<AngularController>();
        Debug.Log(ballPosition);
        angularControllerScript.originPosition = ballPosition;
		GameObject score_text = GameObject.Find("Score_Text");
		TextMesh tm = (TextMesh)score_text.GetComponent("TextMesh");
		tm.text = "スコア : " + score;
		GameObject turn_text = GameObject.Find("Turn_Text");
		TextMesh tm2 = (TextMesh)turn_text.GetComponent("TextMesh");
		tm2.text = "残りターン数 : " + turn;
		tm.text = "スコア : " + score;
		//if all the ball stopped, decrement the number of turn and make user touchable
		if (does_all_ball_stopped()) {
			if (turn <= 0) {
				Application.LoadLevel("result_scene");
				}
			user_touchable = true;
		}
	}
    //ボールが全て止まったかどうかのチェック
    bool does_all_ball_stopped() {
		GameObject my_ball = GameObject.Find("My_Ball");
        if (my_ball.rigidbody.velocity == Vector3.zero) {
            int i;
            for (i=0;i<ball_num;i++) {
                if (balls[i].rigidbody.velocity != Vector3.zero && balls[i].transform.position.y > 0) {
                    return false;
                }
            }
            return true;
        }
        return false;
    }

	void OnGUI () {
		//nothing to do
	}
}
